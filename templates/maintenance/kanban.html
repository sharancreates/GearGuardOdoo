{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/kanban.css') }}">
<script defer src="{{ url_for('static', filename='js/kanban.js') }}"></script>
{% endblock %}

{% block content %}
<div class="kanban-container">

    <div class="kanban-header">
        <h2>Maintenance Kanban</h2>
        <a href="{{ url_for('maintenance.new_request') }}" class="btn-create">
            + New Request
        </a>
    </div>

    <div class="kanban-board">

        <!-- NEW -->
        <div class="kanban-col" data-stage="New">
            <div class="col-title border-new">
                NEW <span class="badge-pill">{{ new_reqs|length }}</span>
            </div>

            {% for req in new_reqs %}
            <div class="task-card animate-in {{ 'is-overdue' if req.is_overdue else '' }}"
                 draggable="true"
                 data-id="{{ req.request_id }}">

                <div class="priority-strip {{ req.priority|lower }}"></div>

                <div class="task-title">{{ req.subject }}</div>
                <div class="task-asset">
                    {{ req.equipment.name if req.equipment else 'No Equipment' }}
                </div>

                <div class="task-footer">
                    {% if req.technician %}
                        <img src="{{ req.technician.avatar_url }}"
                             class="technician-avatar"
                             alt="Technician">
                    {% endif %}

                    <span class="priority-label {{ req.priority|lower }}">
                        {{ req.priority }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- IN PROGRESS -->
        <div class="kanban-col" data-stage="In Progress">
            <div class="col-title border-progress">
                IN PROGRESS <span class="badge-pill">{{ progress_reqs|length }}</span>
            </div>

            {% for req in progress_reqs %}
            <div class="task-card animate-in"
                 draggable="true"
                 data-id="{{ req.request_id }}">

                <div class="priority-strip {{ req.priority|lower }}"></div>

                <div class="task-title">{{ req.subject }}</div>
                <div class="task-asset">
                    {{ req.equipment.name if req.equipment else 'No Equipment' }}
                </div>

                <div class="task-footer">
                    <span class="priority-label {{ req.priority|lower }}">
                        {{ req.priority }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- REPAIRED -->
        <div class="kanban-col" data-stage="Repaired">
            <div class="col-title border-repaired">
                REPAIRED <span class="badge-pill">{{ repaired_reqs|length }}</span>
            </div>

            {% for req in repaired_reqs %}
            <div class="task-card animate-in">
                <div class="task-title">{{ req.subject }}</div>
                <div class="task-asset">
                    {{ req.equipment.name if req.equipment else 'No Equipment' }}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- SCRAP -->
        <div class="kanban-col" data-stage="Scrap">
            <div class="col-title border-scrap">
                SCRAP <span class="badge-pill">{{ scrap_reqs|length }}</span>
            </div>

            {% for req in scrap_reqs %}
            <div class="task-card scrapped animate-in">
                <div class="task-title">{{ req.subject }}</div>
                <small>Scrapped</small>
            </div>
            {% endfor %}
        </div>

    </div>
</div>
{% endblock %}
