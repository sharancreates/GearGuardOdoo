{% extends "base.html" %}

{% block title %}New Maintenance Request{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/request_form.css') }}">
<style>
    /* Ensure the form fits nicely within the base template */
    .dashboard-container {
        padding: 2rem;
        display: flex;
        justify-content: center;
    }

    .sketch-card {
        width: 100%;
        max-width: 900px;
        background: white;
        padding: 2rem;
        border-radius: 12px;
        /* Smooth rounded corners */
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
    }

    .form-header label {
        display: block;
        font-weight: bold;
        color: #2e384d;
        margin-bottom: 0.5rem;
    }

    .title-input {
        width: 100%;
        font-size: 1.5rem;
        border: none;
        border-bottom: 2px solid #ccc;
        padding: 0.5rem;
        outline: none;
        transition: border-color 0.3s;
    }

    .title-input:focus {
        border-bottom-color: #6366f1;
    }

    .status-bar {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .stage {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        color: #888;
        border: 1px solid #ddd;
    }

    .stage.active {
        background: #6366f1;
        color: white;
        border-color: #6366f1;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    .input-group {
        margin-bottom: 1.5rem;
    }

    .input-group label {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        color: #6366f1;
        margin-bottom: 0.5rem;
    }

    .input-group input,
    .input-group select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d3e2;
        border-radius: 8px;
        background: #f8f9fc;
        outline: none;
    }

    .input-group input:focus,
    .input-group select:focus {
        border-color: #6366f1;
        background: white;
    }

    .stars {
        color: #ccc;
        cursor: pointer;
        font-size: 1.2rem;
    }

    .stars .star.selected {
        color: #ffca28;
    }

    .submit-btn {
        margin-top: 2rem;
        width: 100%;
        background: #1cc88a;
        color: white;
        padding: 1rem;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1.1rem;
        cursor: pointer;
        transition: background 0.3s;
    }

    .submit-btn:hover {
        background: #169b6b;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <form method="POST" class="sketch-card">

        <!-- Status Indicator (Visual Only) -->
        <header class="status-bar">
            {% set current_stage = maintenance_request.stage if maintenance_request else 'New' %}
            <div class="stage {{ 'active' if current_stage == 'New' }}">New Request</div>
            <div class="stage {{ 'active' if current_stage == 'In Progress' }}">In Progress</div>
            <div class="stage {{ 'active' if current_stage == 'Repaired' }}">Repaired</div>
            <div class="stage {{ 'active' if current_stage == 'Scrap' }}">Scrap</div>
        </header>

        <div class="form-header">
            <label>Subject</label>
            <input type="text" name="subject" class="title-input"
                value="{{ maintenance_request.subject if maintenance_request else '' }}"
                placeholder="e.g. Broken Conveyor Belt" required minlength="5">
        </div>

        <div class="form-grid">
            <!-- Left Column -->
            <div class="column">
                <div class="input-group">
                    <label>Maintenance Type</label>
                    <select name="request_type" required>
                        <option value="Corrective" {% if maintenance_request and
                            maintenance_request.request_type=='Corrective' %}selected{% endif %}>Corrective</option>
                        <option value="Preventive" {% if maintenance_request and
                            maintenance_request.request_type=='Preventive' %}selected{% endif %}>Preventive</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Equipment</label>
                    <select name="equipment_id" required>
                        <option value="" disabled {% if not maintenance_request %}selected{% endif %}>Select Equipment
                        </option>
                        {% for equip in equipment_list %}
                        <option value="{{ equip.equipment_id }}" {% if maintenance_request and
                            maintenance_request.equipment_id==equip.equipment_id %}selected{% endif %}>
                            {{ equip.name }} ({{ equip.serial_number }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-group">
                    <label>Description</label>
                    <textarea name="description" rows="4"
                        style="width:100%; padding:0.75rem; border-radius:8px; border:1px solid #d1d3e2; background:#f8f9fc;"
                        placeholder="Describe the issue..." required
                        minlength="10">{{ maintenance_request.description if maintenance_request else '' }}</textarea>
                </div>
            </div>

            <!-- Right Column -->
            <div class="column">
                <div class="input-group">
                    <label>Team</label>
                    <select name="team_id">
                        <option value="">-- No Specific Team --</option>
                        {% for team in teams %}
                        <option value="{{ team.team_id }}" {% if maintenance_request and
                            maintenance_request.team_id==team.team_id %}selected{% endif %}>
                            {{ team.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-group">
                    <label>Technician</label>
                    <select name="technician_id">
                        <option value="">-- Assign Technician --</option>
                        {% for user in users %}
                        <option value="{{ user.user_id }}" {% if maintenance_request and
                            maintenance_request.technician_id==user.user_id %}selected{% endif %}>
                            {{ user.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-group">
                    <label>Scheduled Date</label>
                    <!-- Logic: If editing, use existing date. If new from calendar, use prefilled. Else empty. -->
                    {% set date_val = '' %}
                    {% if maintenance_request and maintenance_request.scheduled_date %}
                    {% set date_val = maintenance_request.scheduled_date.strftime('%Y-%m-%dT%H:%M') %}
                    {% elif prefilled_date %}
                    {% set date_val = prefilled_date ~ 'T09:00' %}
                    {% endif %}

                    <input type="datetime-local" name="scheduled_date" value="{{ date_val }}">
                </div>

                <div class="input-group">
                    <label>Duration (Hours)</label>
                    <input type="number" step="0.5" name="duration_hours"
                        value="{{ maintenance_request.duration_hours if maintenance_request else '0.0' }}"
                        placeholder="0.0">
                </div>

                <div class="input-group">
                    <label>Priority</label>
                    <!-- Hidden input -->
                    <input type="hidden" name="priority" id="priorityInput"
                        value="{{ maintenance_request.priority if maintenance_request else 'Normal' }}">
                    <div class="stars" id="starRating">
                        <i class="fas fa-star star" data-value="Low"></i>
                        <i class="fas fa-star star" data-value="Normal"></i>
                        <i class="fas fa-star star" data-value="High"></i>
                    </div>
                    <small id="priorityLabel" style="color:#888;">
                        {{ maintenance_request.priority if maintenance_request else 'Normal' }}
                    </small>
                </div>
            </div>
        </div>

        <button type="submit" class="submit-btn">
            {{ 'Update Request' if maintenance_request else 'Create Request' }}
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Star Rating Logic ---
        const stars = document.querySelectorAll('.star');
        const hiddenInput = document.getElementById('priorityInput');
        const label = document.getElementById('priorityLabel');
        const priorities = ['Low', 'Normal', 'High'];

        // Init: set stars based on current value
        const currentPriority = hiddenInput.value || 'Normal';
        const initialIndex = priorities.indexOf(currentPriority);
        highlightStars(initialIndex >= 0 ? initialIndex : 1);

        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                highlightStars(index);
                hiddenInput.value = priorities[index];
                label.innerText = priorities[index];
            });
        });

        function highlightStars(selectedIndex) {
            stars.forEach((s, i) => {
                if (i <= selectedIndex) {
                    s.classList.add('selected');
                } else {
                    s.classList.remove('selected');
                }
            });
        }

        // --- Auto-Fill Logic (Team & Technician) ---
        const equipmentSelect = document.querySelector('select[name="equipment_id"]');
        const teamSelect = document.querySelector('select[name="team_id"]');
        const technicianSelect = document.querySelector('select[name="technician_id"]');

        if (equipmentSelect) {
            equipmentSelect.addEventListener('change', function () {
                const equipmentId = this.value;
                if (equipmentId) {
                    // Fetch details from our API
                    fetch(`/api/equipment/${equipmentId}/details`)
                        .then(response => response.json())
                        .then(data => {
                            // Update Team
                            if (data.default_team_id) {
                                teamSelect.value = data.default_team_id;
                            } else {
                                teamSelect.value = ""; // Reset if none
                            }

                            // Update Technician
                            if (data.default_technician_id) {
                                technicianSelect.value = data.default_technician_id;
                            } else {
                                technicianSelect.value = ""; // Reset if none
                            }
                        })
                        .catch(err => console.error('Error fetching equipment details:', err));
                }
            });
        }
    });
</script>
{% endblock %}