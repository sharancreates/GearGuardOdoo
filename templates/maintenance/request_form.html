{% extends 'base.html' %}

{% block content %}
    <h2>Create Maintenance Request</h2>

    <form method="POST">
        <label>Subject:</label><br>
        <input type="text" name="subject" placeholder="e.g. Leaking Oil" required><br><br>

        <label>Equipment:</label><br>
        <select name="equipment_id" id="equipment_id" required>
            <option value="">Select Machine...</option>
            {% for item in equipment_list %}
            <option value="{{ item.equipment_id }}">{{ item.name }} ({{ item.serial_number }})</option>
            {% endfor %}
        </select><br><br>

        <label>Request Type:</label><br>
        <select name="request_type" id="request_type" required>
            <option value="Corrective">Corrective (Breakdown)</option>
            <option value="Preventive">Preventive (Scheduled)</option>
        </select><br><br>

        <div style="background-color: #f0f0f0; padding: 10px; border: 1px dashed black;">
            <p><strong>Assignment Details (Auto-filled)</strong></p>
            
            <label>Assigned Team:</label><br>
            <select name="team_id" id="team_id">
                <option value="">(Auto-filled)</option>
                {% for team in teams %}
                <option value="{{ team.team_id }}">{{ team.name }}</option>
                {% endfor %}
            </select><br><br>

            <label>Assigned Technician:</label><br>
            <select name="technician_id" id="technician_id">
                <option value="">(Auto-filled)</option>
                {% for user in users %}
                <option value="{{ user.user_id }}">{{ user.username }}</option>
                {% endfor %}
            </select>
        </div><br>

        <div id="scheduled_date_wrapper" style="display:none;">
            <label>Scheduled Date:</label><br>
            <input type="date" name="scheduled_date"><br><br>
        </div>

        <label>Description:</label><br>
        <textarea name="description" rows="3"></textarea><br><br>

        <label>Priority:</label><br>
        <select name="priority">
            <option value="Normal">Normal</option>
            <option value="High">High</option>
        </select><br><br>

        <button type="submit">Submit Request</button>
    </form>
{% endblock %}

{% block scripts %}
<script>
// Auto-fill Logic
document.getElementById('equipment_id').addEventListener('change', function() {
    let eqId = this.value;
    if(!eqId) return;

    fetch('/api/equipment/' + eqId + '/details')
        .then(response => response.json())
        .then(data => {
            if(data.default_team_id) {
                document.getElementById('team_id').value = data.default_team_id;
            }
            if(data.default_technician_id) {
                document.getElementById('technician_id').value = data.default_technician_id;
            }
        });
});

// Show/Hide Date Field Logic
document.getElementById('request_type').addEventListener('change', function() {
    let wrapper = document.getElementById('scheduled_date_wrapper');
    if(this.value === 'Preventive') {
        wrapper.style.display = 'block';
    } else {
        wrapper.style.display = 'none';
    }
});
</script>
{% endblock %}